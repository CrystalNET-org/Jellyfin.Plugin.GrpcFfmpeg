<!DOCTYPE html>
<html>
<head>
    <title>gRPC-ffmpeg</title>
</head>
<body>
    <div id="grpcFfmpegConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <form class="grpcFfmpegConfigurationForm">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">gRPC-ffmpeg</h2>
                    </div>

                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h2 class="sectionTitle">Deployment</h2>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel" for="deployPathDisplay">Deploy Path</label>
                            <div class="input" id="deployPathDisplay" readonly></div>
                            <div class="fieldDescription">
                                This is the managed path where the binaries will be deployed. Set this path as your FFmpeg path in Jellyfin's main encoding settings.
                            </div>
                        </div>

                        <h3>Wrapped Commands</h3>
                        <div class="fieldDescription">
                            Select which commands should be "wrapped" by creating a copy of the gRPC binary. When Jellyfin calls one of these, it will be sent to the gRPC worker.
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-top: 1em;">
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label>
                                    <input is="emby-checkbox" type="checkbox" id="createFfmpeg" />
                                    <span>ffmpeg</span>
                                </label>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label>
                                    <input is="emby-checkbox" type="checkbox" id="createFfprobe" />
                                    <span>ffprobe</span>
                                </label>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label>
                                    <input is="emby-checkbox" type="checkbox" id="createMediaInfo" />
                                    <span>mediainfo</span>
                                </label>
                            </div>
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label>
                                    <input is="emby-checkbox" type="checkbox" id="createVaInfo" />
                                    <span>vainfo</span>
                                </label>
                            </div>
                        </div>
                        <br/>
                        <div class="fieldDescription" style="color: orange; margin-bottom: 1em;">
                            <strong>Note: Click "Save" first to apply checkbox changes before deploying.</strong>
                        </div>
                        <div>
                            <button is="emby-button" type="button" id="deployButton" class="raised button-accent block"><span>Deploy/Update Binaries & Wrappers</span></button>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h2 class="sectionTitle">gRPC Worker Configuration (config.yml)</h2>
                        </div>
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="useSsl" />
                                <span>Use SSL</span>
                            </label>
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="grpcHost">gRPC Host</label>
                            <input type="text" id="grpcHost" is="emby-input" />
                        </div>
                         <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="grpcPort">gRPC Port</label>
                            <input type="number" id="grpcPort" is="emby-input" />
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="certificatePath">Certificate Path</label>
                            <input type="text" id="certificatePath" is="emby-input" />
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="authToken">Authentication Token</label>
                            <input type="password" id="authToken" is="emby-input" />
                        </div>
                    </div>

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block"><span>Save</span></button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            (function () {
                'use strict';

                const pluginId = "5FCE29C6-1366-41CD-9B05-6447A531B590";
                const page = document.querySelector('#grpcFfmpegConfigPage');

                async function fetchWithAuth(url, method, body) {
                    url = ApiClient.serverAddress() + "/" + url;
                    const reqInit = {
                        method: method,
                        headers: { 'Authorization': `MediaBrowser Token="${ApiClient.accessToken()}"` },
                        body: body,
                    };
                    if (method === "POST" && body) {
                        reqInit.headers["Content-Type"] = "application/json";
                    }
                    return await fetch(url, reqInit);
                }

                function loadConfiguration() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(pluginId).then(config => {
                        page.querySelector('#createFfmpeg').checked = config.CreateFfmpeg;
                        page.querySelector('#createFfprobe').checked = config.CreateFfprobe;
                        page.querySelector('#createMediaInfo').checked = config.CreateMediaInfo;
                        page.querySelector('#createVaInfo').checked = config.CreateVaInfo;
                        page.querySelector('#useSsl').checked = config.UseSsl;
                        page.querySelector('#grpcHost').value = config.GrpcHost || '';
                        page.querySelector('#grpcPort').value = config.GrpcPort || 0;
                        page.querySelector('#certificatePath').value = config.CertificatePath || '';
                        page.querySelector('#authToken').value = config.AuthToken || '';
                    });
                    
                    fetchWithAuth('GrpcFfmpeg/DeployPath', 'GET').then(response => response.json()).then(data => {
                        page.querySelector('#deployPathDisplay').textContent = data.Path;
                        Dashboard.hideLoadingMsg();
                    });
                }

                page.addEventListener('pageshow', loadConfiguration);

                page.querySelector('.grpcFfmpegConfigurationForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();
                    const form = this;

                    ApiClient.getPluginConfiguration(pluginId).then(config => {
                        config.CreateFfmpeg = form.querySelector('#createFfmpeg').checked;
                        config.CreateFfprobe = form.querySelector('#createFfprobe').checked;
                        config.CreateMediaInfo = form.querySelector('#createMediaInfo').checked;
                        config.CreateVaInfo = form.querySelector('#createVaInfo').checked;
                        config.UseSsl = form.querySelector('#useSsl').checked;
                        config.GrpcHost = form.querySelector('#grpcHost').value;
                        config.GrpcPort = parseInt(form.querySelector('#grpcPort').value) || 0;
                        config.CertificatePath = form.querySelector('#certificatePath').value;
                        config.AuthToken = form.querySelector('#authToken').value;

                        return ApiClient.updatePluginConfiguration(pluginId, config);
                    }).then(result => {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        loadConfiguration(); // Refresh data on page
                        // No need to pass a promise along anymore
                    }).catch(error => {
                        Dashboard.hideLoadingMsg();
                        console.error("Save error:", error);
                        Dashboard.alert({
                            title: "Save Failed",
                            text: "An error occurred while saving configuration. Please check the browser console and server logs."
                        });
                    });
                    
                    return false;
                });
                
                page.querySelector('#deployButton').addEventListener('click', function () {
                    Dashboard.showLoadingMsg();
                    fetchWithAuth('GrpcFfmpeg/Deploy', 'POST', null)
                        .then(response => {
                            Dashboard.hideLoadingMsg();
                            if (response.ok) {
                                Dashboard.alert({
                                    title: "Deployment Successful",
                                    text: "Binaries and wrappers updated successfully."
                                });
                                loadConfiguration(); // Refresh deploy path display
                            } else {
                                response.json().then(error => {
                                    console.error("Deploy error:", error);
                                    Dashboard.alert({
                                        title: "Deployment Error",
                                        text: `Error deploying binaries: ${error.message}`
                                    });
                                }).catch(jsonError => { // Catch error if response.json() fails
                                    console.error("Deploy error (non-JSON response):", deployResponse);
                                    Dashboard.alert({
                                        title: "Deployment Error",
                                        text: "An unknown error occurred during deployment."
                                    });
                                });
                            }
                        }).catch(error => {
                            Dashboard.hideLoadingMsg();
                            console.error("Deployment process error:", error);
                            Dashboard.alert({
                                title: "Error",
                                text: "An unexpected error occurred during deployment."
                            });
                        });
                });
            })();
        </script>
    </div>
</body>
</html>
